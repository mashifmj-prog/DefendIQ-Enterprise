      <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DefendIQ Enterprise - Cybersecurity Learning Platform</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Landing Page -->
    <section id="landingPage" class="landing-page">
        <div class="landing-container">
            <div class="logo">üõ°Ô∏è</div>
            <h1 class="title">DefendIQ Enterprise</h1>
            <p class="slogan">Defend with Confidence, Grow with Ease!</p>
            <div class="landing-stats">
                <div class="stat">
                    <div class="stat-number">5</div>
                    <div class="stat-label">Departments</div>
                </div>
                <div class="stat">
                    <div class="stat-number">52</div>
                    <div class="stat-label">Training Modules</div>
                </div>
                <div class="stat">
                    <div class="stat-number">94%</div>
                    <div class="stat-label">Success Rate</div>
                </div>
            </div>
            <button id="enterEnterprise" class="btn btn-primary btn-large">
                Enter Enterprise Platform
            </button>
            <div class="landing-features">
                <div class="feature">
                    <div class="feature-icon">üéØ</div>
                    <h3>AI-Powered Learning</h3>
                    <p>Meet Zara - your 24/7 cybersecurity mentor and life coach</p>
                </div>
                <div class="feature">
                    <div class="feature-icon">ü§ñ</div>
                    <h3>Emotional Intelligence</h3>
                    <p>Context-aware support that understands your work and life</p>
                </div>
                <div class="feature">
                    <div class="feature-icon">üåç</div>
                    <h3>South African Context</h3>
                    <p>Localized training with load-shedding aware scheduling</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Department Selection Overlay -->
    <div id="departmentSelection" class="overlay" style="display: none;">
        <div class="overlay-content">
            <div class="logo">üõ°Ô∏è</div>
            <h1>DefendIQ Enterprise</h1>
            <p class="subtitle">Select Your Department</p>
            <div class="department-cards">
                <div class="department-card" data-department="nms">
                    <div class="card-icon">üåê</div>
                    <h3>NMS Command Center</h3>
                    <p>Network Infrastructure Protection & Vendor Security</p>
                    <div class="card-stats">
                        <span>12 Modules</span>
                        <span>Advanced</span>
                    </div>
                </div>
                <div class="department-card" data-department="hr">
                    <div class="card-icon">üë•</div>
                    <h3>HR Guardian Hub</h3>
                    <p>Data Privacy, Compliance & Employee Protection</p>
                    <div class="card-stats">
                        <span>10 Modules</span>
                        <span>Compliance</span>
                    </div>
                </div>
                <div class="department-card" data-department="it">
                    <div class="card-icon">üíª</div>
                    <h3>IT Cyber Station</h3>
                    <p>System Defense & Incident Response</p>
                    <div class="card-stats">
                        <span>15 Modules</span>
                        <span>Technical</span>
                    </div>
                </div>
                <div class="department-card" data-department="finance">
                    <div class="card-icon">üí∞</div>
                    <h3>Finance Security Hub</h3>
                    <p>Financial Fraud Prevention & Transaction Security</p>
                    <div class="card-stats">
                        <span>8 Modules</span>
                        <span>Financial</span>
                    </div>
                </div>
                <div class="department-card" data-department="customer-service">
                    <div class="card-icon">üéØ</div>
                    <h3>Customer Service Shield</h3>
                    <p>Client Data Protection & Social Engineering Defense</p>
                    <div class="card-stats">
                        <span>7 Modules</span>
                        <span>Client-Facing</span>
                    </div>
                </div>
            </div>
            <button id="backToLanding" class="btn btn-secondary" style="margin-top: 30px;">
                Back to Landing Page
            </button>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="app-container" style="display: none;">
        <!-- Navigation Bar -->
        <nav class="nav-bar">
            <div class="nav-brand">
                <span class="nav-logo">üõ°Ô∏è</span>
                <span class="nav-title">DefendIQ</span>
                <span class="department-badge" id="departmentBadge">Enterprise</span>
            </div>
            <div class="nav-controls">
                <button id="departmentSwitch" class="nav-btn">Switch Dept</button>
                <button id="homeBtn" class="nav-btn">Home</button>
                <button id="refreshBtn" class="nav-btn">Refresh</button>
            </div>
        </nav>

        <!-- Training Mode -->
        <section id="trainingMode" class="app-section">
            <div class="dashboard">
                <!-- Department Header -->
                <div class="department-header" id="departmentHeader">
                    <h1 id="deptTitle">Department Training Center</h1>
                    <p id="deptDescription">Comprehensive cybersecurity training</p>
                </div>

                <!-- Enhanced Stats Overview -->
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-label">Security Score</div>
                        <div class="stat-value" id="securityScore">85</div>
                        <div class="stat-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 85%;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Modules Completed</div>
                        <div class="stat-value" id="modulesCompleted">8/12</div>
                        <div class="stat-label">Current Streak: <span id="streakValue">5</span> days</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Threat Detection</div>
                        <div class="stat-value" id="threatsDetected">94%</div>
                        <div class="stat-label">Accuracy Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">AI Support Level</div>
                        <div class="stat-value" id="supportLevel">Active</div>
                        <div class="stat-label" id="supportStatus">Zara is online</div>
                    </div>
                </div>

                <!-- AI Progress Insight -->
                <div class="ai-insight" id="aiInsight">
                    <div class="insight-icon">üí°</div>
                    <div class="insight-content">
                        <h4>Zara's Insight</h4>
                        <p id="insightMessage">You're making great progress! Based on your learning pattern, you're ready for the next challenge.</p>
                    </div>
                </div>

                <!-- Module Grid -->
                <div class="module-grid" id="moduleGrid">
                    <!-- Modules will be dynamically loaded here -->
                </div>

                <!-- Module Content -->
                <div class="module-content" id="moduleContent" style="display: none;">
                    <div class="module-header">
                        <h2 id="moduleTitle">Module Title</h2>
                        <button id="closeModule" class="nav-btn">Back to Modules</button>
                    </div>
                    <div id="moduleBody">
                        <!-- Module content will be loaded here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Enhanced Support Mode -->
        <section id="supportMode" class="app-section" style="display: none;">
            <div class="support-container">
                <div class="support-header">
                    <div class="zara-profile">
                        <div class="zara-avatar">ü§ñ</div>
                        <div class="zara-info">
                            <h2>Zara AI Support</h2>
                            <p>Your Cybersecurity Guardian & Life Coach</p>
                        </div>
                    </div>
                    <div class="support-features">
                        <span class="feature-tag">üéØ Context-Aware</span>
                        <span class="feature-tag">‚ù§Ô∏è Emotionally Intelligent</span>
                        <span class="feature-tag">üåç SA Context</span>
                        <span class="feature-tag">üïí 24/7 Available</span>
                    </div>
                    <div class="support-status">
                        <span id="currentMode">Work Hours Mode</span>
                        <span class="status-dot online"></span>
                    </div>
                </div>
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message ai-message fade-in">
                            <div class="message-sender">Zara</div>
                            <p>Hello! I'm Zara, your AI cybersecurity companion! üõ°Ô∏è I'm here to help with security questions, training guidance, or just to chat about work and life. What's on your mind today?</p>
                            <div class="message-time" id="currentTime"></div>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Ask about cybersecurity, share how you're feeling, or get life advice...">
                        <button id="sendBtn" class="send-btn">Send</button>
                    </div>
                    <div class="chat-suggestions">
                        <button class="suggestion-btn" data-message="I'm feeling stressed today">üòî I'm stressed</button>
                        <button class="suggestion-btn" data-message="What module should I do next?">üéØ Next module</button>
                        <button class="suggestion-btn" data-message="Tell me a cybersecurity joke">üòÑ Make me laugh</button>
                        <button class="suggestion-btn" data-message="I need life advice">üí≠ Life advice</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Mode Selector -->
        <div class="mode-selector">
            <button id="trainingTab" class="mode-tab active">Training</button>
            <button id="supportTab" class="mode-tab">Support</button>
        </div>
    </div>

    <!-- Canvas Background -->
    <div class="canvas-container">
        <canvas id="backgroundCanvas"></canvas>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #121212;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        color: #e0e0e0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    ">
        <div style="font-size: 4rem; margin-bottom: 20px;">üõ°Ô∏è</div>
        <h2 style="margin-bottom: 10px; color: #2e7d32;">DefendIQ Enterprise</h2>
        <p style="margin-bottom: 30px; color: #9e9e9e;">Initializing Zara AI System...</p>
        <div style="width: 200px; height: 4px; background: #1e1e1e; border-radius: 2px;">
            <div id="loadingProgress" style="height: 100%; background: #2e7d32; border-radius: 2px; width: 0%; transition: width 0.3s;"></div>
        </div>
        <div id="loadingStatus" style="margin-top: 15px; font-size: 0.9rem; color: #9e9e9e;">Loading AI intelligence modules...</div>
    </div>

    <!-- All JavaScript Combined -->
    <script>
        // Combined application script with enhanced AI support
        console.log('üöÄ Starting DefendIQ Enterprise with Zara AI...');

        // Update loading status
        function updateLoadingStatus(message, percent) {
            const status = document.getElementById('loadingStatus');
            const progress = document.getElementById('loadingProgress');
            if (status) status.textContent = message;
            if (progress) progress.style.width = percent + '%';
            console.log(`üì¶ ${message} (${percent}%)`);
        }

        // Enhanced departments data
        const departments = {
            nms: {
                id: 'nms',
                name: 'NMS Command Center',
                description: 'Network Infrastructure Protection & Vendor Security',
                color: '#2196f3',
                icon: 'üåê',
                modules: [
                    {
                        id: 'nms-1',
                        title: 'Network Infrastructure Security',
                        icon: 'üîí',
                        description: 'Protecting network systems from social engineering attacks',
                        difficulty: 'Advanced',
                        estimatedTime: '45 min',
                        objectives: [
                            'Identify social engineering tactics targeting NMS teams',
                            'Implement secure network change procedures',
                            'Protect network configuration data',
                            'Establish vendor security protocols'
                        ],
                        content: {
                            materials: [
                                {
                                    title: 'Understanding NMS Vulnerabilities',
                                    content: 'Network Management Systems are prime targets for attackers seeking infrastructure access.'
                                }
                            ],
                            quiz: [
                                {
                                    question: 'A vendor emails requesting emergency network configuration changes. What should you do first?',
                                    options: [
                                        'Implement the changes immediately',
                                        'Verify the request through established secure channels',
                                        'Forward to your manager',
                                        'Ignore the request'
                                    ],
                                    correct: 1,
                                    explanation: 'Always verify emergency requests through established secure communication channels before implementation.'
                                }
                            ]
                        }
                    }
                ]
            },
            hr: {
                id: 'hr',
                name: 'HR Guardian Hub',
                description: 'Data Privacy, Compliance & Employee Protection',
                color: '#9c27b0',
                icon: 'üë•',
                modules: [
                    {
                        id: 'hr-1',
                        title: 'Employee Data Protection',
                        icon: 'üìä',
                        description: 'Safeguarding sensitive employee information and POPIA compliance',
                        difficulty: 'Intermediate',
                        estimatedTime: '40 min',
                        objectives: [
                            'Understand POPIA requirements',
                            'Implement secure data handling',
                            'Protect employee privacy',
                            'Establish access controls'
                        ],
                        content: {
                            materials: [
                                {
                                    title: 'POPIA Compliance Essentials',
                                    content: 'Understanding the Protection of Personal Information Act requirements for employee data handling and protection.'
                                }
                            ],
                            quiz: [
                                {
                                    question: 'Under POPIA, employee consent for data processing must be:',
                                    options: [
                                        'Optional',
                                        'Implied',
                                        'Specific and informed',
                                        'Verbal only'
                                    ],
                                    correct: 2,
                                    explanation: 'POPIA requires specific, informed consent for personal data processing.'
                                }
                            ]
                        }
                    }
                ]
            },
            it: {
                id: 'it',
                name: 'IT Cyber Station',
                description: 'System Defense & Incident Response',
                color: '#f44336',
                icon: 'üíª',
                modules: [
                    {
                        id: 'it-1',
                        title: 'Privilege Access Management',
                        icon: 'üîë',
                        description: 'Managing administrative access and preventing privilege escalation',
                        difficulty: 'Advanced',
                        estimatedTime: '50 min',
                        objectives: [
                            'Implement least privilege principle',
                            'Monitor administrative access',
                            'Prevent privilege escalation',
                            'Manage service accounts'
                        ],
                        content: {
                            materials: [
                                {
                                    title: 'Principle of Least Privilege',
                                    content: 'Granting only the minimum access necessary for job functions to reduce attack surface.'
                                }
                            ],
                            quiz: [
                                {
                                    question: 'The principle of least privilege means:',
                                    options: [
                                        'Grant all access by default',
                                        'Grant minimum necessary access',
                                        'No access for anyone',
                                        'Access based on seniority'
                                    ],
                                    correct: 1,
                                    explanation: 'Users should have only the access necessary to perform their job functions.'
                                }
                            ]
                        }
                    }
                ]
            },
            finance: {
                id: 'finance',
                name: 'Finance Security Hub',
                description: 'Financial Fraud Prevention & Transaction Security',
                color: '#4caf50',
                icon: 'üí∞',
                modules: [
                    {
                        id: 'finance-1',
                        title: 'Financial Fraud Prevention',
                        icon: 'üö´',
                        description: 'Detecting and preventing financial fraud and social engineering attacks',
                        difficulty: 'Intermediate',
                        estimatedTime: '40 min',
                        objectives: [
                            'Identify financial fraud patterns',
                            'Verify transaction authenticity',
                            'Prevent social engineering attacks',
                            'Implement financial controls'
                        ],
                        content: {
                            materials: [
                                {
                                    title: 'Financial Fraud Patterns',
                                    content: 'Common patterns and red flags in financial fraud attempts targeting organizations.'
                                }
                            ],
                            quiz: [
                                {
                                    question: 'A CEO emails requesting urgent wire transfer. What should you do?',
                                    options: [
                                        'Process immediately',
                                        'Verify through secondary channel',
                                        'Ask accounting department',
                                        'Ignore the request'
                                    ],
                                    correct: 1,
                                    explanation: 'Always verify financial requests through established secondary communication channels.'
                                }
                            ]
                        }
                    }
                ]
            },
            'customer-service': {
                id: 'customer-service',
                name: 'Customer Service Shield',
                description: 'Client Data Protection & Social Engineering Defense',
                color: '#ff9800',
                icon: 'üéØ',
                modules: [
                    {
                        id: 'cs-1',
                        title: 'Client Data Protection',
                        icon: 'üõ°Ô∏è',
                        description: 'Safeguarding customer information and preventing social engineering',
                        difficulty: 'Intermediate',
                        estimatedTime: '35 min',
                        objectives: [
                            'Protect customer data',
                            'Verify client identities',
                            'Prevent social engineering',
                            'Follow data handling protocols'
                        ],
                        content: {
                            materials: [
                                {
                                    title: 'Customer Data Security',
                                    content: 'Best practices for protecting customer information during service interactions.'
                                }
                            ],
                            quiz: [
                                {
                                    question: 'A caller claims to be a client and requests account information. What should you do first?',
                                    options: [
                                        'Provide the information',
                                        'Verify identity through known channels',
                                        'Transfer to manager',
                                        'Hang up immediately'
                                    ],
                                    correct: 1,
                                    explanation: 'Always verify client identity through established verification procedures.'
                                }
                            ]
                        }
                    }
                ]
            }
        };

        updateLoadingStatus('Departments loaded', 20);

        // Enhanced Zara AI System
        const zaraAI = {
            // User memory system
            userMemory: {
                stressors: [],
                preferences: {},
                progress: {},
                conversations: []
            },

            // Time-based personality system
            getCurrentPersonality() {
                const hour = new Date().getHours();
                const day = new Date().getDay();
                const isWeekend = day === 0 || day === 6;
                
                if (isWeekend) return 'weekend';
                if (hour >= 22 || hour < 6) return 'lateNight';
                if (hour >= 18) return 'evening';
                if (hour >= 12) return 'afternoon';
                return 'workHours';
            },

            // Personality responses
            personalities: {
                workHours: {
                    greeting: "Good morning! Ready to conquer cybersecurity today? üõ°Ô∏è",
                    tone: "professional",
                    humor: "work-appropriate",
                    focus: "productivity"
                },
                afternoon: {
                    greeting: "Good afternoon! How's your day going? üåû",
                    tone: "friendly", 
                    humor: "playful",
                    focus: "momentum"
                },
                evening: {
                    greeting: "Evening! Time to wind down or still crushing it? üåá",
                    tone: "relaxed",
                    humor: "chill",
                    focus: "balance"
                },
                lateNight: {
                    greeting: "Late night thoughts? I'm here for you üåô",
                    tone: "gentle",
                    humor: "subtle",
                    focus: "support"
                },
                weekend: {
                    greeting: "Weekend mode! Learning or relaxing? üéâ",
                    tone: "casual",
                    humor: "lighthearted", 
                    focus: "enjoyment"
                }
            },

            // Enhanced response generator
            generateResponse(userMessage, department, progress) {
                const personality = this.personalities[this.getCurrentPersonality()];
                const lowerMessage = userMessage.toLowerCase();
                
                // Store conversation
                this.userMemory.conversations.push({
                    message: userMessage,
                    timestamp: new Date().toISOString(),
                    mood: this.detectMood(userMessage)
                });

                // Crisis detection
                if (this.detectCrisis(userMessage)) {
                    return this.generateCrisisResponse();
                }

                // Life support triggers
                if (this.isLifeSupportTrigger(lowerMessage)) {
                    return this.generateLifeSupportResponse(lowerMessage, personality);
                }

                // Work-related triggers
                if (this.isWorkTrigger(lowerMessage)) {
                    return this.generateWorkResponse(lowerMessage, department, progress, personality);
                }

                // Default intelligent response
                return this.generateIntelligentResponse(lowerMessage, personality);
            },

            // Mood detection
            detectMood(message) {
                const positive = ['great', 'good', 'happy', 'excited', 'awesome', 'amazing'];
                const negative = ['stress', 'stressed', 'tired', 'overwhelmed', 'sad', 'angry', 'frustrated'];
                const neutral = ['ok', 'fine', 'alright', 'whatever'];
                
                if (positive.some(word => message.includes(word))) return 'positive';
                if (negative.some(word => message.includes(word))) return 'negative';
                if (neutral.some(word => message.includes(word))) return 'neutral';
                return 'unknown';
            },

            // Crisis detection
            detectCrisis(message) {
                const crisisWords = ['suicide', 'kill myself', 'end it all', 'harm myself', 'emergency', 'urgent help'];
                return crisisWords.some(word => message.toLowerCase().includes(word));
            },

            generateCrisisResponse() {
                return "I hear the deep pain in your words, and I'm genuinely concerned. ü´Ç While I'm here to support you, what you're describing needs immediate professional care. Please contact the South African Depression and Anxiety Group (SADAG) at 0800 456 789 right now. They have trained people who can help immediately. I'll stay right here with you.";
            },

            // Life support system
            isLifeSupportTrigger(message) {
                const triggers = {
                    stress: ['stress', 'overwhelmed', 'pressure', 'anxious', 'worried'],
                    family: ['child', 'kids', 'family', 'son', 'daughter', 'parent'],
                    home: ['renovation', 'home', 'house', 'moving', 'contractor'],
                    health: ['tired', 'sick', 'sleep', 'exhausted', 'burnout'],
                    workLife: ['balance', 'time', 'busy', 'schedule', 'deadline']
                };
                
                return Object.values(triggers).flat().some(trigger => message.includes(trigger));
            },

            generateLifeSupportResponse(message, personality) {
                const responses = {
                    stress: [
                        "I hear you're feeling stressed. Remember, even cybersecurity heroes need breaks! üßò‚Äç‚ôÇÔ∏è",
                        "Stress is temporary, but your strength is permanent. You've got this! üí™",
                        "Let's breathe together. In... and out... You're handling this better than you think! üå¨Ô∏è"
                    ],
                    family: [
                        "Family challenges can be tough. Your care shows what a wonderful person you are! üë®‚Äçüë©‚Äçüëß‚Äçüë¶",
                        "Parenting/relationships are a journey. You're doing better than you realize! üåü",
                        "Family first always. Your dedication is inspiring! üíù"
                    ],
                    home: [
                        "Home projects can be stressful! Remember, this temporary chaos leads to beautiful results! üè°",
                        "Renovations test patience but build character! You're handling it like a champ! üî®",
                        "One room at a time! You'll get through this home challenge! üõ†Ô∏è"
                    ],
                    health: [
                        "Your wellbeing matters most. Remember to listen to your body! üíö",
                        "Even machines need maintenance - and you're much more valuable! Take care of yourself! üè•",
                        "Rest is part of productivity. Your health is your greatest asset! üò¥"
                    ]
                };

                // Find the most relevant category
                for (const [category, words] of Object.entries({
                    stress: ['stress', 'overwhelmed', 'pressure'],
                    family: ['child', 'family', 'kids'],
                    home: ['renovation', 'home', 'house'],
                    health: ['tired', 'sick', 'exhausted']
                })) {
                    if (words.some(word => message.includes(word))) {
                        const categoryResponses = responses[category];
                        return categoryResponses[Math.floor(Math.random() * categoryResponses.length)];
                    }
                }

                return "I'm here for you, whatever you're going through. You're stronger than you think! üí´";
            },

            // Work response system
            isWorkTrigger(message) {
                const workWords = ['phishing', 'security', 'module', 'training', 'work', 'report', 'meeting', 'deadline'];
                return workWords.some(word => message.includes(word));
            },

            generateWorkResponse(message, department, progress, personality) {
                if (message.includes('module') || message.includes('training')) {
                    return this.generateTrainingResponse(progress, personality);
                }
                
                if (message.includes('phishing') || message.includes('security')) {
                    return this.generateSecurityResponse(department, personality);
                }

                return this.generateGeneralWorkResponse(personality);
            },

            generateTrainingResponse(progress, personality) {
                const completed = progress.completedModules || 0;
                const total = progress.totalModules || 1;
                const completionRate = Math.round((completed / total) * 100);
                
                if (completionRate < 30) {
                    return `You're just getting started on your cybersecurity journey! üöÄ With ${completed}/${total} modules complete, you're building a solid foundation. Want to tackle the next one together?`;
                } else if (completionRate < 70) {
                    return `You're making amazing progress! ${completed}/${total} modules complete - you're becoming a security pro! üåü Ready for the next challenge?`;
                } else {
                    return `Wow! ${completed}/${total} modules complete - you're in the cybersecurity elite! üèÜ Want to master the final modules and become a true security champion?`;
                }
            },

            generateSecurityResponse(department, personality) {
                const securityTips = {
                    nms: "For NMS teams, always verify vendor requests through multiple channels. Social engineers love targeting network access! üîí",
                    hr: "HR professionals should remember: POPIA requires specific consent for data processing. When in doubt, verify! üìä",
                    it: "IT teams: Implement the principle of least privilege and monitor for unusual access patterns. Your vigilance protects everyone! üíª",
                    finance: "Finance colleagues: Always use dual verification for transactions. Business Email Compromise attacks are on the rise! üí∞",
                    'customer-service': "Customer service: Verify client identity through multiple questions. Social engineers often target service desks! üéØ"
                };

                return securityTips[department] || "Remember: When in doubt, verify! Cybersecurity is about building good habits. üõ°Ô∏è";
            },

            generateGeneralWorkResponse(personality) {
                const responses = {
                    workHours: "Staying focused during work hours? Remember to take short breaks - they actually improve productivity! ‚è∞",
                    afternoon: "Afternoon energy dip? How about a quick cybersecurity quiz to wake up your brain? üß†",
                    evening: "Working late? Your dedication is impressive! Remember to balance work and rest. üåÉ",
                    lateNight: "Late night work session? You're committed! But don't forget - even cybersecurity heroes need sleep! üåô",
                    weekend: "Working on the weekend? Your passion is inspiring! Maybe mix in some fun too? üéâ"
                };

                return responses[personality] || "You're doing great work! Remember to celebrate your progress along the way. üåü";
            },
            
            generateIntelligentResponse(message, personality) {
                // Humor integration based on personality
                const humor = {
                    workHours: "I'd make a joke about UDP, but you might not get it! üòÑ (IT humor!)",
                    afternoon: "Why don't hackers tell good jokes? Because they always break in! üòÜ",
                    evening: "I was going to tell you a cybersecurity joke, but it's encrypted! üîê",
                    lateNight: "Why was the computer cold? It left its Windows open! ‚ùÑÔ∏è",
                    weekend: "What's a hacker's favorite season? Phishing season! üé£"
                };

                const thoughtful = {
                    workHours: "I'm here to help with anything - work challenges, security questions, or just to chat! üó£Ô∏è",
                    afternoon: "Every question you ask makes you more secure. Your curiosity is your superpower! üîç",
                    evening: "Learning never stops, and neither does my support for you! üåô",
                    lateNight: "The night often brings clarity. What's on your mind? üí≠",
                    weekend: "Weekends are for growth and relaxation. How can I support you today? üåü"
                };

                // 50% chance of humor during appropriate times
                if (Math.random() > 0.5 && personality !== 'lateNight') {
                    return humor[personality];
                }
                
                return thoughtful[personality];
            },

            // Update current mode display
            updateModeDisplay() {
                const modeElement = document.getElementById('currentMode');
                const personality = this.getCurrentPersonality();
                const modeNames = {
                    workHours: "Work Hours Mode",
                    afternoon: "Afternoon Support", 
                    evening: "Evening Companion",
                    lateNight: "Night Owl Mode",
                    weekend: "Weekend Buddy"
                };
                
                if (modeElement) {
                    modeElement.textContent = modeNames[personality];
                }
            }
        };

        updateLoadingStatus('Zara AI system loaded', 40);

        // State management
        const state = {
            appState: null,

            getDefaultState() {
                return {
                    currentDepartment: null,
                    currentMode: 'training',
                    userProfile: {
                        name: '',
                        employeeId: '',
                        department: '',
                        role: '',
                        knowledgeLevel: 'beginner'
                    },
                    departmentProgress: {
                        nms: this.createDepartmentState('nms'),
                        hr: this.createDepartmentState('hr'),
                        it: this.createDepartmentState('it'),
                        finance: this.createDepartmentState('finance'),
                        'customer-service': this.createDepartmentState('customer-service')
                    },
                    chatHistory: [],
                    lastActivity: new Date().toISOString()
                };
            },

            createDepartmentState(departmentId) {
                const deptModules = departments[departmentId]?.modules || [];
                return {
                    departmentId: departmentId,
                    modules: deptModules.map(module => ({
                        id: module.id,
                        completed: false,
                        progress: 0,
                        quizScore: 0
                    })),
                    overallScore: 0,
                    completedModules: 0
                };
            },

            loadState() {
                try {
                    const savedState = localStorage.getItem('defendIQEnterprise');
                    if (savedState) {
                        this.appState = JSON.parse(savedState);
                    } else {
                        this.appState = this.getDefaultState();
                    }
                } catch (error) {
                    this.appState = this.getDefaultState();
                }
            },

            saveState() {
                if (this.appState) {
                    try {
                        this.appState.lastActivity = new Date().toISOString();
                        localStorage.setItem('defendIQEnterprise', JSON.stringify(this.appState));
                    } catch (error) {
                        console.error('Save failed:', error);
                    }
                }
            },

            setCurrentDepartment(departmentId) {
                if (this.appState) {
                    this.appState.currentDepartment = departmentId;
                    this.appState.userProfile.department = departmentId;
                    this.saveState();
                }
            },

            getCurrentDepartment() {
                return this.appState?.currentDepartment || null;
            },

            getDepartmentState(departmentId) {
                return this.appState?.departmentProgress[departmentId] || this.createDepartmentState(departmentId);
            },

            addChatMessage(sender, message) {
                if (!this.appState) return null;

                const chatMessage = {
                    id: Date.now().toString(),
                    sender: sender,
                    message: message,
                    timestamp: new Date().toISOString(),
                    departmentId: this.appState.currentDepartment
                };
                
                this.appState.chatHistory.push(chatMessage);
                
                if (this.appState.chatHistory.length > 100) {
                    this.appState.chatHistory = this.appState.chatHistory.slice(-100);
                }
                
                this.saveState();
                return chatMessage;
            }
        };

        updateLoadingStatus('State management ready', 60);

        // Enhanced UI management
        const ui = {
            init() {
                updateLoadingStatus('Initializing UI...', 70);
                this.setupEventListeners();
                this.showLandingPage();
                this.updateTimeDisplay();
                updateLoadingStatus('UI ready', 85);
            },

            showLandingPage() {
                const landingPage = document.getElementById('landingPage');
                const departmentSelection = document.getElementById('departmentSelection');
                const appContainer = document.getElementById('appContainer');
                
                if (landingPage) landingPage.style.display = 'flex';
                if (departmentSelection) departmentSelection.style.display = 'none';
                if (appContainer) appContainer.style.display = 'none';
            },

            showDepartmentSelection() {
                const landingPage = document.getElementById('landingPage');
                const departmentSelection = document.getElementById('departmentSelection');
                const appContainer = document.getElementById('appContainer');
                
                if (landingPage) landingPage.style.display = 'none';
                if (departmentSelection) departmentSelection.style.display = 'flex';
                if (appContainer) appContainer.style.display = 'none';
            },

            showApp() {
                const landingPage = document.getElementById('landingPage');
                const departmentSelection = document.getElementById('departmentSelection');
                const appContainer = document.getElementById('appContainer');
                
                if (landingPage) landingPage.style.display = 'none';
                if (departmentSelection) departmentSelection.style.display = 'none';
                if (appContainer) appContainer.style.display = 'block';
            },

            selectDepartment(departmentId) {
                state.setCurrentDepartment(departmentId);
                this.showApp();
                this.updateDepartmentUI();
                this.showTrainingMode();
            },

            updateDepartmentUI() {
                const departmentId = state.getCurrentDepartment();
                const department = departments[departmentId];
                
                if (department) {
                    const deptTitle = document.getElementById('deptTitle');
                    const deptDescription = document.getElementById('deptDescription');
                    const departmentBadge = document.getElementById('departmentBadge');
                    
                    if (deptTitle) deptTitle.textContent = department.name;
                    if (deptDescription) deptDescription.textContent = department.description;
                    if (departmentBadge) {
                        departmentBadge.textContent = department.name;
                        departmentBadge.style.background = department.color;
                    }
                    
                    this.loadDepartmentModules();
                    this.updateDepartmentStats();
                }
            },

            loadDepartmentModules() {
                const departmentId = state.getCurrentDepartment();
                const department = departments[departmentId];
                const moduleGrid = document.getElementById('moduleGrid');
                
                if (moduleGrid && department) {
                    moduleGrid.innerHTML = '';
                    
                    department.modules.forEach(module => {
                        const moduleCard = this.createModuleCard(module, departmentId);
                        moduleGrid.appendChild(moduleCard);
                    });
                }
            },

            createModuleCard(module, departmentId) {
                const deptState = state.getDepartmentState(departmentId);
                const moduleProgress = deptState.modules.find(m => m.id === module.id) || { progress: 0, completed: false };
                
                const card = document.createElement('div');
                card.className = `module-card ${moduleProgress.completed ? 'completed' : moduleProgress.progress > 0 ? 'in-progress' : ''}`;
                card.innerHTML = `
                    <div class="module-header-card">
                        <div class="module-icon">${module.icon}</div>
                        <div>
                            <h3>${module.title}</h3>
                            <div class="module-meta">
                                <span>${module.difficulty}</span>
                                <span>${module.estimatedTime}</span>
                            </div>
                        </div>
                    </div>
                    <p class="module-description">${module.description}</p>
                    <div class="module-progress">
                        <div class="progress-text">
                            <span>Progress</span>
                            <span>${moduleProgress.progress}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${moduleProgress.progress}%"></div>
                        </div>
                    </div>
                `;
                
                card.addEventListener('click', () => {
                    this.openModule(module, departmentId);
                });
                
                return card;
            },

            openModule(module, departmentId) {
                const moduleContent = document.getElementById('moduleContent');
                const moduleTitle = document.getElementById('moduleTitle');
                const moduleBody = document.getElementById('moduleBody');
                
                if (moduleContent && moduleTitle && moduleBody) {
                    moduleTitle.textContent = module.title;
                    moduleBody.innerHTML = this.createModuleContent(module, departmentId);
                    
                    document.getElementById('moduleGrid').style.display = 'none';
                    moduleContent.style.display = 'block';
                }
            },

            createModuleContent(module, departmentId) {
                return `
                    <div class="module-overview">
                        <h3>Learning Objectives</h3>
                        <ul class="objectives-list">
                            ${module.objectives.map(obj => `<li>${obj}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="learning-materials">
                        <h3>Learning Materials</h3>
                        ${module.content.materials.map(material => `
                            <div class="material-item">
                                <h4>${material.title}</h4>
                                <p>${material.content}</p>
                            </div>
                        `).join('')}
                    </div>
                    <div class="quiz-section">
                        <h3>Knowledge Check</h3>
                        <p>Test your understanding with this quick quiz.</p>
                        <button class="btn btn-primary" onclick="quiz.startQuiz('${departmentId}', '${module.id}')">
                            Start Quiz
                        </button>
                    </div>
                `;
            },

            showTrainingMode() {
                const trainingMode = document.getElementById('trainingMode');
                const supportMode = document.getElementById('supportMode');
                const trainingTab = document.getElementById('trainingTab');
                const supportTab = document.getElementById('supportTab');
                
                if (trainingMode && supportMode) {
                    trainingMode.style.display = 'block';
                    supportMode.style.display = 'none';
                }
                if (trainingTab && supportTab) {
                    trainingTab.classList.add('active');
                    supportTab.classList.remove('active');
                }
            },

            showSupportMode() {
                const trainingMode = document.getElementById('trainingMode');
                const supportMode = document.getElementById('supportMode');
                const trainingTab = document.getElementById('trainingTab');
                const supportTab = document.getElementById('supportTab');
                
                if (trainingMode && supportMode) {
                    trainingMode.style.display = 'none';
                    supportMode.style.display = 'block';
                }
                if (trainingTab && supportTab) {
                    trainingTab.classList.remove('active');
                    supportTab.classList.add('active');
                }
                
                this.updateSupportView();
                zaraAI.updateModeDisplay();
            },

            updateSupportView() {
                const chatMessages = document.getElementById('chatMessages');
                
                if (chatMessages && chatMessages.children.length <= 1) {
                    const personality = zaraAI.getCurrentPersonality();
                    const greeting = zaraAI.personalities[personality].greeting;
                    this.addMessage(greeting, 'ai');
                }
            },

            updateDepartmentStats() {
                const departmentId = state.getCurrentDepartment();
                if (!departmentId) return;

                const deptState = state.getDepartmentState(departmentId);
                const completedModules = deptState.modules.filter(m => m.completed).length;
                const totalModules = deptState.modules.length;
                const completionRate = totalModules > 0 ? Math.round((completedModules / totalModules) * 100) : 0;
                
                // Update UI elements
                const securityScore = document.getElementById('securityScore');
                const modulesCompleted = document.getElementById('modulesCompleted');
                
                if (securityScore) securityScore.textContent = completionRate;
                if (modulesCompleted) modulesCompleted.textContent = `${completedModules}/${totalModules}`;
            },

            addMessage(text, sender) {
                const chatMessages = document.getElementById('chatMessages');
                if (!chatMessages) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message fade-in`;
                
                if (sender === 'ai') {
                    messageDiv.innerHTML = `
                        <div class="message-sender">Zara</div>
                        <p>${text}</p>
                        <div class="message-time">${new Date().toLocaleTimeString()}</div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="message-sender">You</div>
                        <p>${text}</p>
                        <div class="message-time">${new Date().toLocaleTimeString()}</div>
                    `;
                }
                
                chatMessages.appendChild(messageDiv);
                state.addChatMessage(sender, text);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            },

            updateTimeDisplay() {
                const timeElement = document.getElementById('currentTime');
                if (timeElement) {
                    timeElement.textContent = new Date().toLocaleTimeString();
                }
            },

            setupEventListeners() {
                // Landing page
                const enterEnterprise = document.getElementById('enterEnterprise');
                if (enterEnterprise) {
                    enterEnterprise.addEventListener('click', () => this.showDepartmentSelection());
                }

                // Department selection
                const backToLanding = document.getElementById('backToLanding');
                if (backToLanding) {
                    backToLanding.addEventListener('click', () => this.showLandingPage());
                }

                document.querySelectorAll('.department-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const department = card.dataset.department;
                        this.selectDepartment(department);
                    });
                });

                // Navigation
                const departmentSwitch = document.getElementById('departmentSwitch');
                if (departmentSwitch) {
                    departmentSwitch.addEventListener('click', () => this.showDepartmentSelection());
                }

                const homeBtn = document.getElementById('homeBtn');
                if (homeBtn) {
                    homeBtn.addEventListener('click', () => this.showTrainingMode());
                }

                // Mode tabs
                const trainingTab = document.getElementById('trainingTab');
                const supportTab = document.getElementById('supportTab');
                
                if (trainingTab) {
                    trainingTab.addEventListener('click', () => this.showTrainingMode());
                }
                if (supportTab) {
                    supportTab.addEventListener('click', () => this.showSupportMode());
                }

                // Close module
                const closeModule = document.getElementById('closeModule');
                if (closeModule) {
                    closeModule.addEventListener('click', () => this.closeModuleView());
                }

                // Chat functionality
                const sendBtn = document.getElementById('sendBtn');
                const chatInput = document.getElementById('chatInput');
                
                if (sendBtn && chatInput) {
                    sendBtn.addEventListener('click', () => this.sendMessage());
                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.sendMessage();
                    });
                }

                // Suggestion buttons
                document.querySelectorAll('.suggestion-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const message = btn.dataset.message;
                        this.sendSuggestion(message);
                    });
                });
            },

            closeModuleView() {
                const moduleContent = document.getElementById('moduleContent');
                const moduleGrid = document.getElementById('moduleGrid');
                
                if (moduleContent && moduleGrid) {
                    moduleContent.style.display = 'none';
                    moduleGrid.style.display = 'grid';
                }
            },

            sendMessage() {
                const chatInput = document.getElementById('chatInput');
                const message = chatInput.value.trim();
                
                if (!message) return;
                
                this.addMessage(message, 'user');
                chatInput.value = '';
                
                setTimeout(() => {
                    const department = state.getCurrentDepartment();
                    const deptState = state.getDepartmentState(department);
                    const response = zaraAI.generateResponse(message, department, deptState);
                    this.addMessage(response, 'ai');
                }, 1000);
            },

            sendSuggestion(message) {
                const chatInput = document.getElementById('chatInput');
                chatInput.value = message;
                this.sendMessage();
            }
        };

        updateLoadingStatus('UI components loaded', 90);

        // Quiz system
        const quiz = {
            startQuiz(departmentId, moduleId) {
                const department = departments[departmentId];
                const module = department.modules.find(m => m.id === moduleId);
                
                if (module && module.content.quiz) {
                    const firstQuestion = module.content.quiz[0];
                    const moduleBody = document.getElementById('moduleBody');
                    
                    if (moduleBody) {
                        moduleBody.innerHTML = `
                            <div class="quiz-container">
                                <h3>Quiz: ${module.title}</h3>
                                <div class="quiz-question">
                                    <h4>${firstQuestion.question}</h4>
                                    <div class="quiz-options">
                                        ${firstQuestion.options.map((option, index) => `
                                            <button class="quiz-option" onclick="quiz.answerQuestion(${index}, ${firstQuestion.correct}, '${departmentId}', '${moduleId}')">
                                                ${option}
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
            },

            answerQuestion(selectedIndex, correctIndex, departmentId, moduleId) {
                const isCorrect = selectedIndex === correctIndex;
                const moduleBody = document.getElementById('moduleBody');
                const department = departments[departmentId];
                const module = department.modules.find(m => m.id === moduleId);
                const question = module.content.quiz[0];
                
                if (moduleBody) {
                    if (isCorrect) {
                        moduleBody.innerHTML = `
                            <div class="quiz-results">
                                <h3>‚úÖ Correct! Well done! üéâ</h3>
                                <p>${question.explanation}</p>
                                <p><strong>You've mastered this concept!</strong></p>
                                <button class="btn btn-primary" onclick="ui.closeModuleView(); ui.updateDepartmentStats();">
                                    Return to Modules
                                </button>
                            </div>
                        `;
                        
                        // Update progress
                        const deptState = state.getDepartmentState(departmentId);
                        const moduleProgress = deptState.modules.find(m => m.id === moduleId);
                        if (moduleProgress) {
                            moduleProgress.completed = true;
                            moduleProgress.progress = 100;
                            moduleProgress.quizScore = 100;
                            deptState.completedModules++;
                            state.saveState();
                        }
                    } else {
                        moduleBody.innerHTML = `
                            <div class="quiz-results">
                                <h3>‚ùå Not quite right</h3>
                                <p><strong>Correct answer:</strong> ${question.options[correctIndex]}</p>
                                <p>${question.explanation}</p>
                                <p>Don't worry - learning is a journey! Review the material and try again.</p>
                                <button class="btn btn-secondary" onclick="quiz.startQuiz('${departmentId}', '${moduleId}')">
                                    Try Again
                                </button>
                            </div>
                        `;
                    }
                }
            }
        };

        // Canvas system
        const canvas = {
            init() {
                const canvas = document.getElementById('backgroundCanvas');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    this.resizeCanvas(canvas, ctx);
                    this.animate(canvas, ctx);
                }
            },

            resizeCanvas(canvas, ctx) {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                
                // Draw initial background
                ctx.fillStyle = '#121212';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            },

            animate(canvas, ctx) {
                // Simple animated background
                const draw = () => {
                    ctx.fillStyle = 'rgba(18, 18, 18, 0.05)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Draw some moving particles
                    const time = Date.now() * 0.001;
                    for (let i = 0; i < 5; i++) {
                        const x = (Math.sin(time + i) * 0.5 + 0.5) * canvas.width;
                        const y = (Math.cos(time * 0.7 + i) * 0.5 + 0.5) * canvas.height;
                        
                        ctx.beginPath();
                        ctx.arc(x, y, 2, 0, Math.PI * 2);
                        ctx.fillStyle = 'rgba(46, 125, 50, 0.3)';
                        ctx.fill();
                    }
                    
                    requestAnimationFrame(draw);
                };
                
                draw();
            }
        };

        updateLoadingStatus('All systems ready', 95);

        // Initialize everything when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            updateLoadingStatus('Starting application...', 100);
            
            try {
                // Load state first
                state.loadState();
                
                // Initialize canvas
                canvas.init();
                
                // Initialize UI
                ui.init();
                
                // Hide loading indicator after a delay
                setTimeout(() => {
                    const loadingIndicator = document.getElementById('loadingIndicator');
                    if (loadingIndicator) {
                        loadingIndicator.style.display = 'none';
                    }
                    console.log('üéØ DefendIQ Enterprise with Zara AI ready!');
                }, 1000);
                
            } catch (error) {
                console.error('Initialization failed:', error);
                updateLoadingStatus('Initialization failed - check console', 100);
            }
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            const canvas = document.getElementById('backgroundCanvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                ctx.fillStyle = '#121212';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
        });

        console.log('üì¶ Enhanced DefendIQ Enterprise with Zara AI loaded successfully');
    </script>
</body>
</html>